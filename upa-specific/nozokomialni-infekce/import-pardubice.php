<?php

$pracovisteMap = array(
  'TRA-5H3' => array('oddeleni'=>'Traum', 'pracoviste'=>'TRA-5H3', 'odbornost'=>'5H3', 'typPece'=>'S'),
  'TRA-JIP1'=> array('oddeleni'=>'Traum', 'pracoviste'=>'TRA-JIP1', 'odbornost'=>'5I3', 'typPece'=>'I'),
  'ORL-7H1' => array('oddeleni'=>'ORL', 'pracoviste'=>'ORL-7H1', 'odbornost'=>'7H1', 'typPece'=>'S'),
  'ORL-7H2' => array('oddeleni'=>'ORL', 'pracoviste'=>'ORL-7H2', 'odbornost'=>'7H2', 'typPece'=>'S'),
  'CEV-5H4' => array('oddeleni'=>'CevCh', 'pracoviste'=>'CEV-5H4', 'odbornost'=>'5H4', 'typPece'=>'S'),
  'CEV-JIP1' => array('oddeleni'=>'CevCh', 'pracoviste'=>'CEV-JIP1', 'odbornost'=>'5I4', 'typPece'=>'I'),//???
  'N_CEV-J1' => array('oddeleni'=>'CevCh', 'pracoviste'=>'N_CEV-J1', 'odbornost'=>'5I4', 'typPece'=>'I'),//???
  'CEV-JIP' => array('oddeleni'=>'CevCh', 'pracoviste'=>'CEV-JIP', 'odbornost'=>'5I4', 'typPece'=>'I'),//???
  '6266' => array('oddeleni'=>'CevCh', 'pracoviste'=>'6266', 'odbornost'=>'5H4', 'typPece'=>'S'),//???
  'CHI-5H1' => array('oddeleni'=>'Chiru', 'pracoviste'=>'CHI-5H1', 'odbornost'=>'5H1', 'typPece'=>'S'),
  'ORT-6H6' => array('oddeleni'=>'Ortop', 'pracoviste'=>'ORT-6H6', 'odbornost'=>'6H6', 'typPece'=>'S'),
  'NCH-5H6' => array('oddeleni'=>'NChir', 'pracoviste'=>'NCH-5H6', 'odbornost'=>'5H6', 'typPece'=>'S'),
  'NCH-JIP'=> array('oddeleni'=>'NChir', 'pracoviste'=>'NCH-JIP', 'odbornost'=>'5I6', 'typPece'=>'I'),
  'NCH-JIP1'=> array('oddeleni'=>'NChir', 'pracoviste'=>'NCH-JIP1', 'odbornost'=>'5I6', 'typPece'=>'I'),
  'DCH-5H2' => array('oddeleni'=>'DChir', 'pracoviste'=>'DCH-5H2', 'odbornost'=>'5H2', 'typPece'=>'S'),
  'NCH-5I6' => array('oddeleni'=>'NChir', 'pracoviste'=>'NCH-5I6', 'odbornost'=>'5I6', 'typPece'=>'I'),
  'CHI-JIP' => array('oddeleni'=>'Chiru', 'pracoviste'=>'CHI-JIP', 'odbornost'=>'5I1', 'typPece'=>'I'),
  'GCN-LDN' => array('oddeleni'=>'Geria', 'pracoviste'=>'GCN-LDN', 'odbornost'=>'1U6', 'typPece'=>'N'),
  'INT-5p'  => array('oddeleni'=>'Gastr', 'pracoviste'=>'INT-5p', 'odbornost'=>'1H5', 'typPece'=>'S'),
  'URO-7H6' => array('oddeleni'=>'Urolo', 'pracoviste'=>'URO-7H6', 'odbornost'=>'7H6', 'typPece'=>'S'),
  'GCN-LDN1'=> array('oddeleni'=>'LDN', 'pracoviste'=>'GCN-LDN1', 'odbornost'=>'9U7', 'typPece'=>'N'),
  'GCN-LDN2'=> array('oddeleni'=>'LDN', 'pracoviste'=>'GCN-LDN2', 'odbornost'=>'9U7', 'typPece'=>'N'),//???
  'CHI-JIP1'=> array('oddeleni'=>'Chiru', 'pracoviste'=>'CHI-JIP1', 'odbornost'=>'5I1', 'typPece'=>'I'),
  'N_CHI-J1'=> array('oddeleni'=>'Chiru', 'pracoviste'=>'N_CHI-J1', 'odbornost'=>'5I1', 'typPece'=>'I'),//???
  'N_CHI-JI'=> array('oddeleni'=>'Chiru', 'pracoviste'=>'N_CHI-JI', 'odbornost'=>'5I1', 'typPece'=>'I'),//???
  'K1-1H7'  => array('oddeleni'=>'Kardi', 'pracoviste'=>'K1-1H7', 'odbornost'=>'1H7', 'typPece'=>'S'),
  'K2-1H7'  => array('oddeleni'=>'Kardi', 'pracoviste'=>'K2-1H7', 'odbornost'=>'1H7', 'typPece'=>'S'),
  'K2-2H7'  => array('oddeleni'=>'Imuno', 'pracoviste'=>'K2-2H7', 'odbornost'=>'2H7', 'typPece'=>'S'),
  'GCG-Ger1'=> array('oddeleni'=>'Geria', 'pracoviste'=>'GCG-Ger1', 'odbornost'=>'1H6', 'typPece'=>'S'),//???
  'GCG-Ger2'=> array('oddeleni'=>'Geria', 'pracoviste'=>'GCG-Ger2', 'odbornost'=>'1H6', 'typPece'=>'S'),//???
  'GCG-GER' => array('oddeleni'=>'Geria', 'pracoviste'=>'GCG-GER', 'odbornost'=>'1H6', 'typPece'=>'S'),//???
  'ARO-7I8' => array('oddeleni'=>'ARO', 'pracoviste'=>'ARO-7I8', 'odbornost'=>'7I8', 'typPece'=>'I'),
  'NOV-3H4' => array('oddeleni'=>'Novor', 'pracoviste'=>'NOV-3H4', 'odbornost'=>'3H4', 'typPece'=>'S'),
  'NOV-IMP1'=> array('oddeleni'=>'Novor', 'pracoviste'=>'NOV-IMP1', 'odbornost'=>'3H4', 'typPece'=>'S'),//???
  'NOV-IMP2'=> array('oddeleni'=>'Novor', 'pracoviste'=>'NOV-IMP2', 'odbornost'=>'3H4', 'typPece'=>'S'),//???
  'NOV-3I4' => array('oddeleni'=>'Novor', 'pracoviste'=>'NOV-3I4', 'odbornost'=>'3I4', 'typPece'=>'I'),
  'NEU-2H9' => array('oddeleni'=>'Neuro', 'pracoviste'=>'NEU-2H9', 'odbornost'=>'2H9', 'typPece'=>'S'),
  'NEU-2I9' => array('oddeleni'=>'Neuro', 'pracoviste'=>'NEU-2I9', 'odbornost'=>'2I9', 'typPece'=>'I'),
  'INT-JIP' => array('oddeleni'=>'Inter', 'pracoviste'=>'INT-JIP', 'odbornost'=>'1I1', 'typPece'=>'I'),
  'INT-6p'  => array('oddeleni'=>'Inter', 'pracoviste'=>'INT-6p', 'odbornost'=>'1H1', 'typPece'=>'S'),//???
  'DET-3H1' => array('oddeleni'=>'Pedia', 'pracoviste'=>'DET-3H1', 'odbornost'=>'3H1', 'typPece'=>'S'),
  'KAJ-1I7' => array('oddeleni'=>'Kardi', 'pracoviste'=>'KAJ-1I7', 'odbornost'=>'1I7', 'typPece'=>'I'),
  'INF-2H3' => array('oddeleni'=>'Infek', 'pracoviste'=>'INF-2H3', 'odbornost'=>'2H3', 'typPece'=>'S'),
  'INF' => array('oddeleni'=>'Infek', 'pracoviste'=>'INF-2H3', 'odbornost'=>'2H3', 'typPece'=>'S'),//???
  'KKJ-1I7' => array('oddeleni'=>'Kardi', 'pracoviste'=>'KKJ-1I7', 'odbornost'=>'1I7', 'typPece'=>'I'),
  'RHB-2H1' => array('oddeleni'=>'Rehab', 'pracoviste'=>'RHB-2H1', 'odbornost'=>'2H1', 'typPece'=>'S'),
  'TRN-2H5' => array('oddeleni'=>'Pneum', 'pracoviste'=>'TRN-2H5', 'odbornost'=>'2H5', 'typPece'=>'S'),
  'KIP-1I7' => array('oddeleni'=>'Kardi', 'pracoviste'=>'KIP-1I7', 'odbornost'=>'1I7', 'typPece'=>'I'),
  'RAD-4F3' => array('oddeleni'=>'Radio', 'pracoviste'=>'RAD-4F3', 'odbornost'=>'4F3', 'typPece'=>'S'),//???
  'HEM-2H2' => array('oddeleni'=>'Hemat', 'pracoviste'=>'HEM-2H2', 'odbornost'=>'2H2', 'typPece'=>'S'),
  'GYN-6H3' => array('oddeleni'=>'Gynek', 'pracoviste'=>'GYN-6H3', 'odbornost'=>'6H3', 'typPece'=>'S'),
  'ONK-4F3' => array('oddeleni'=>'Onkol', 'pracoviste'=>'ONK-4F3', 'odbornost'=>'4F3', 'typPece'=>'S'),//???
  'OCN-7H5' => array('oddeleni'=>'Ocni', 'pracoviste'=>'OCN-7H5', 'odbornost'=>'7H5', 'typPece'=>'S'),
);

$typInfekceMap = array(
  'Hluboká infekce' => array('simple'=>'IMChV', 'spec'=>'ChHlu'),
  'Povrchová infekce' => array('simple'=>'IMChV', 'spec'=>'ChPov'),
  'Infekce orgánů a prostor' => array('simple'=>'IMChV', 'spec'=>'ChOrg'),
  'infekce krevního řečiště' => array('simple'=>'IKR', 'spec'=>'IKR'),
  'katétrová infekce kr. řečiště' => array('simple'=>'IKR', 'spec'=>'KIKR'),
  'infekční endokarditida' => array('simple'=>'IKR', 'spec'=>'IEKar'),
  'septická tromboflebitida' => array('simple'=>'IKR', 'spec'=>'SeTro'),
  'Infekce GIT (tenké, tlusté střevo, rektum)' => array('simple'=>'GENT', 'spec'=>'IGIT'),
  'Gastroenteritida' => array('simple'=>'GENT', 'spec'=>'GENT'),
  'Infekce ucha' => array('simple'=>'Jina', 'spec'=>'Ucho'),
  'Infekce kůže' => array('simple'=>'Jina', 'spec'=>'Kuze'),
  'Infekce měkké tkáně' => array('simple'=>'Jina', 'spec'=>'Mekka'),
  'Infekce tepny nebo žíly' => array('simple'=>'Jina', 'spec'=>'Tepna'),
  'Nekrotizující kolitida' => array('simple'=>'Jina', 'spec'=>'NeKol'),
  'Dekubitus' => array('simple'=>'Jina', 'spec'=>'Dekub'),
  'symptomatická močová infekce (SUTI)' => array('simple'=>'IMT', 'spec'=>'SUTI'),
  'Bronchitida (bez známek pneumonie)' => array('simple'=>'IRT', 'spec'=>'Bronc'),
  'Laryngitida' => array('simple'=>'IRT', 'spec'=>'Laryn'),
  'Faryngitida' => array('simple'=>'IRT', 'spec'=>'Faryn'),
  'pneumonie bez souvislosti s UPV' => array('simple'=>'IRT', 'spec'=>'Pneum'),
  'Tracheitida (bez známek pneumonie)' => array('simple'=>'IRT', 'spec'=>'Trach'),
  'ventilátorová pneumonie - VAP' => array('simple'=>'IRT', 'spec'=>'VAP'),
  'Tracheobronchitida (bez známek pneumonie)' => array('simple'=>'IRT', 'spec'=>'TrBro'),
  'Infekce kloubu nebo bursy' => array('simple'=>'Jina', 'spec'=>'Kloub'),
  'Infekce dutiny ustní' => array('simple'=>'Jina', 'spec'=>'Usta'),
  'Popálenina' => array('simple'=>'Jina', 'spec'=>'Popal'),
  'jiná infekce DCD' => array('simple'=>'Jina', 'spec'=>'Jina'),
  'jiná infekce' => array('simple'=>'Jina', 'spec'=>'Jina'),
  'Jiné neznámé' => array('simple'=>'Jina', 'spec'=>'Jina'),
  'Jiná' => array('simple'=>'Jina', 'spec'=>'Jina'),
  '' => array('simple'=>'Jina', 'spec'=>'Jina'),
);

$klasifikaceMap = array(
  'nozokomiální primární'=>'Prima',
  'nozokomiální importovaná primární'=>'Prima',
  'komunitní primární'=>'Prima',
  'nozokomiální sekundární'=>'Sekun',
  'komunitní sekundární'=>'Sekun',
  'nozokomiální importovaná sekundární'=>'Sekun',
  'nozokomiální neurčená'=>'Neurc',
);
$zdrojSekundarniMap = array(
  'močové ústrojí'=>'Urolo',
  'měkká tkáň'=>'MekTk',
  'kloub'=>'Kloub',
  'chirurgická rána'=>'ChRan',
  'žlučové cesty'=>'Zluco',
  'dolní cesty dýchací'=>'DCD',
  'gastrointestinální ústrojí'=>'Gastr',
  'pohlavní ústrojí ženy'=>'Gynek',
  'retroperitoneální prostor'=>'RetPe',
  'jiný'=>'Jiny',
);
$intervenceMap = array(
  'centrální venosní katét'=>'CVKat',
  'periferní venosní katétr'=>'PVKat',
  'arteriální katétr'=>'AKat',
  'kardiostimulační systém'=>'KStim',
  'Permanentní močový katétr'=>'PMoKa',
  'Endotracheální Intubace'=>'ETInt',
  'chirurgický výkon'=>'Chir',
  'chlopenní náhrada'=>'ChlNa',
);
$vznikMap = array(
  'vznik po propuštění na ambulanci'=>'PoPro',
  'vznik za hospitalizace'=>'ZaHos',
  'importovaná NN'=>'Impor',
);

$worksheet = $workbook->getActiveSheet();

$rows = $worksheet->getHighestDataRow();
$maxCols = $worksheet->getHighestDataColumn();
$columns = 0;
for ($i=0; $i<strlen($maxCols); $i++) {
  $columns+=$columns*25 + (ord($maxCols[$i]) - 64);
}

$sloupce = array();
for ($i=0; $i<$columns; $i++) {
  $sloupec = trim($worksheet->getCellByColumnAndRow($i, 1)->getValue());
  switch ($sloupec) {
    case '':
    case 'Oddělení':
    case 'Obor':
    case 'Odbornost':
    case 'Založil':
    case 'Suma':
    case 'Typ péče':
    case 'Validita případu':
    case 'Dat.provedení operace':
    case 'Operatér':
      //Ignorováno
      break;
    case 'Pracoviště':
      $sloupce['pracoviste'] = $i;
      break;
    case 'Kód př.':
      $sloupce['kodPripadu'] = $i;
      break;
    case 'Datum vzniku':
      $sloupce['datumVzniku'] = $i;
      break;
    case 'Vznik':
      $sloupce['vznik'] = $i;
      break;
    case 'Typ infekce':
    case 'Klinická dg. infekce':
      $sloupce['typInfekce'] = $i;
      break;
    case 'Výkon (Medix) všeobecná a hrudní chirurgie':
    case 'Výkon (Medix) jiná odbornost':
    case 'Ostatní operační obory':
    case 'Jiný operační výkon':
      if (!isset($sloupce['operacniVykony'])) {
        $sloupce['operacniVykony'] = array();
      }
      $sloupce['operacniVykony'][] = $i;
      break;
    case 'Původce':
      $sloupce['puvodce'] = $i;
      break;
    case 'Jiný původce':
      $sloupce['jinyPuvodce'] = $i;
      break;
    case 'Nezařazený původce':
    case 'Nezařazený  původce':
      $sloupce['nezarazenyPuvodce'] = $i;
      break;
    case 'PEN':
    case 'AMP':
    case 'OXA':
    case 'PIP':
    case 'CTX':
    case 'CTZ':
    case 'MER':
    case 'STR':
    case 'GEN':
    case 'AMI':
    case 'CIP':
    case 'ERY':
    case 'VAN':
    case 'FLU':
    case 'MRSA':
    case 'ESBL':
    case 'AMPC':
    case 'VRE':
      if (!isset($sloupce['rezistence'])) {
        $sloupce['rezistence'] = array();
      }
      $sloupce['rezistence'][$sloupec] = $i;
      break;
    case 'Poznámka':
      $sloupce['poznamka'] = $i;
      break;
    case 'Klasifikace':
      $sloupce['klasifikace'] = $i;
      break;
    case 'Zdroj sek. infekce':
      $sloupce['zdrojSekundarni'] = $i;
      break;
    case 'Intervence':
      $sloupce['intervence'] = $i;
      break;
    case 'Dat.prov. interv.':
    case 'Dat.prov.intervence':
      $sloupce['datumIntervence'] = $i;
      break;
    default:
      throw new Exception('Neznámý sloupec v tabulce: "' . $sloupec .  '"');
  }
}

$dataSpec = array(
/*
  array(
.    oddeleni
.    pracoviste
.    odbornost
.    typPece
.    typInfekce
.    klasifikace
.    zdrojSekundarni
.    operacniVykony
.    intervence
.    datumIntervence
    puvodce
.    vznik
.    datumVzniku
.    poznamka
  )
*/
);
for ($i=2; $i<=$rows; $i++) {
  $kodPripadu = trim($worksheet->getCellByColumnAndRow($sloupce['kodPripadu'], $i)->getValue());
  if (!$kodPripadu) {
    continue;
  }
  $datumVzniku = trim($worksheet->getCellByColumnAndRow($sloupce['datumVzniku'], $i)->getValue());
  if (preg_match('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', $datumVzniku)) {
    $datumVzniku=mktime(0, 0, 0,
      preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\2', $datumVzniku),
      preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\1', $datumVzniku),
      preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\3', $datumVzniku));
  } elseif (is_numeric($datumVzniku)) {
    $datumVzniku=($datumVzniku - 25569) * 86400;
  } else {
    throw new Exception('Neznámý formát data vzniku "' . $datumVzniku . '"');
  }
  $klic = $kodPripadu . ';' . date('Y-m-d', $datumVzniku);
  if (!isset($dataSpec[$klic])) {
    $dataSpec[$klic] = array();
    $dataSpec[$klic]['datumVzniku'] = $datumVzniku;

    $dataSpec[$klic]['pracoviste'] = trim($worksheet->getCellByColumnAndRow($sloupce['pracoviste'], $i)->getValue());// -> oddeleni, pracoviste, odbornost, typPece
    $dataSpec[$klic]['typInfekce'] = trim($worksheet->getCellByColumnAndRow($sloupce['typInfekce'], $i)->getValue());
    if (isset($sloupce['klasifikace'])) {
      $dataSpec[$klic]['klasifikace'] = trim($worksheet->getCellByColumnAndRow($sloupce['klasifikace'], $i)->getValue());
    } else {
      $dataSpec[$klic]['klasifikace'] = '';
    }
    if (isset($sloupce['zdrojSekundarni'])) {
      $dataSpec[$klic]['zdrojSekundarni'] = trim($worksheet->getCellByColumnAndRow($sloupce['zdrojSekundarni'], $i)->getValue());
    } else {
      $dataSpec[$klic]['zdrojSekundarni'] = '';
    }
    if (isset($sloupce['operacniVykony'])) {
      $operacniVykony = array();
      foreach ($sloupce['operacniVykony'] as $j) {
        $operacniVykony[] = trim($worksheet->getCellByColumnAndRow($j, $i)->getValue());
      }
      $dataSpec[$klic]['operacniVykony'] = implode("\n", $operacniVykony);
    } else {
      $dataSpec[$klic]['operacniVykony'] = '';
    }
    if (isset($sloupce['intervence'])) {
      $dataSpec[$klic]['intervence'] = trim($worksheet->getCellByColumnAndRow($sloupce['intervence'], $i)->getValue());
    } else {
      $dataSpec[$klic]['intervence'] = '';
    }
    if (isset($sloupce['datumIntervence'])) {
      $datumIntervence = trim($worksheet->getCellByColumnAndRow($sloupce['datumIntervence'], $i)->getValue());
      if ($datumIntervence) {
        if (preg_match('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', $datumIntervence)) {
          $dataSpec[$klic]['datumIntervence']=mktime(0, 0, 0,
            preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\2', $datumIntervence),
            preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\1', $datumIntervence),
            preg_replace('/([0-9]{1,2})\.([0-9]{1,2})\.([0-9]{4})/', '\3', $datumIntervence));
        } elseif (is_numeric($datumIntervence)) {
          $dataSpec[$klic]['datumIntervence']=($datumIntervence - 25569) * 86400;
        } else {
          throw new Exception('Neznámý formát data intervence "' . $datumIntervence . '"');
        }
      } else {
        $dataSpec[$klic]['datumIntervence'] = '';
      }
    } else {
      $dataSpec[$klic]['datumIntervence'] = '';
    }
    if (isset($sloupce['vznik'])) {
      $dataSpec[$klic]['vznik'] = trim($worksheet->getCellByColumnAndRow($sloupce['vznik'], $i)->getValue());
    } else {
      $dataSpec[$klic]['vznik'] = '';
    }
    
    $dataSpec[$klic]['poznamky'] = array();
    $dataSpec[$klic]['puvodci'] = array();
  }
  
  
  if (isset($sloupce['poznamka'])) {
    $dataSpec[$klic]['poznamky'][] = trim($worksheet->getCellByColumnAndRow($sloupce['poznamka'], $i)->getValue());
  }
  
  $puvodce = trim($worksheet->getCellByColumnAndRow($sloupce['puvodce'], $i)->getValue());
  $dataSpec[$klic]['puvodci'][$puvodce] = array();
  if (isset($sloupce['jinyPuvodce'])) {
    $jinyPuvodce = trim($worksheet->getCellByColumnAndRow($sloupce['jinyPuvodce'], $i)->getValue());
  } else {
    $jinyPuvodce = '';
  }
  if (isset($sloupce['nezarazenyPuvodce'])) {
    $nezarazenyPuvodce = trim($worksheet->getCellByColumnAndRow($sloupce['nezarazenyPuvodce'], $i)->getValue());
  } else {
    $nezarazenyPuvodce = '';
  }
  $dataSpec[$klic]['puvodci'][$puvodce]['jinyPuvodce'] = $jinyPuvodce;
  if ($nezarazenyPuvodce) {
    if ($dataSpec[$klic]['puvodci'][$puvodce]['jinyPuvodce']) {
      $dataSpec[$klic]['puvodci'][$puvodce]['jinyPuvodce'].=',';
    }
    $dataSpec[$klic]['puvodci'][$puvodce]['jinyPuvodce'].=$nezarazenyPuvodce;
  }
  $dataSpec[$klic]['puvodci'][$puvodce]['rezistence'] = array();
  foreach(array('PEN','AMP','OXA','PIP','CTX','CTZ','MER','STR','GEN','AMI','CIP','ERY','VAN','FLU','MRSA','ESBL','AMPC','VRE') as $rez) {
    $dataSpec[$klic]['puvodci'][$puvodce]['rezistence'][$rez] = trim($worksheet->getCellByColumnAndRow($sloupce['rezistence'][$rez], $i)->getValue());
  }
}

$dataPardubice = array();
foreach ($dataSpec as $pripad) {
  $dataItem = array();
  $poznamky = $pripad['poznamky'];
  
  if (!isset($pracovisteMap[$pripad['pracoviste']])) {
    throw new Exception('Neznámé pracoviště "' . $pripad['pracoviste'] . '"');
  }
  $dataItem['oddeleni'] = $pracovisteMap[$pripad['pracoviste']]['oddeleni'];
  $dataItem['pracoviste'] = $pracovisteMap[$pripad['pracoviste']]['pracoviste'];
  $dataItem['odbornost'] = $pracovisteMap[$pripad['pracoviste']]['odbornost'];  
  $dataItem['typPece'] = $pracovisteMap[$pripad['pracoviste']]['typPece'];  
  
  if (!isset($typInfekceMap[$pripad['typInfekce']])) {
    throw new Exception('Neznámý typ infekce "' . $pripad['typInfekce'] . '"');
  }
  $dataItem['typInfekce'] = $typInfekceMap[$pripad['typInfekce']]['simple'];  
  $dataItem['typInfekceSpec'] = $typInfekceMap[$pripad['typInfekce']]['spec'];  

  $dataItem['datumVzniku'] = date('Y-m-d', $pripad['datumVzniku']);
  
  $dataItem['puvodci'] = array();
  $dataItem['puvodciSpec'] = array();
  $dataItem['puvodceJiny'] = array();
  $dataItem['rezistence'] = array();
  foreach ($pripad['puvodci'] as $puvodce=>$p) {
    if (!isset($puvodciMap[$puvodce])) {
      throw new Exception('Neznámý původce "' . $puvodce . '"');
    }
    $dataItem['puvodci'][] = $puvodciMap[$puvodce];
    if ($puvodciMap[$puvodce]) {
      $dataItem['puvodciSpec'][] = array(
        'puvodce'=>$puvodciMap[$puvodce],
        'rezistence'=>$p['rezistence']
      );
    } else {
      $dataItem['puvodciSpec'][] = array(
        'puvodce'=>'Jiny',
        'rezistence'=>$p['rezistence']
      );
    }
    if ($p['jinyPuvodce']) {
      $dataItem['puvodceJiny'][] = $p['jinyPuvodce'];
    }
    foreach(array('MRSA', 'ESBL', 'AMPC', 'VRE') as $rez) {
      if($p['rezistence'][$rez]) {
        $dataItem['rezistence'][] = $rez;
      }
    }
  }
  $dataItem['puvodceJiny'] = implode(', ', $dataItem['puvodceJiny']);
  
  /*spec*/
  if ($pripad['klasifikace']) {
    if (!isset($klasifikaceMap[$pripad['klasifikace']])) {
      throw new Exception('Neznámá klasifikace "' . $pripad['klasifikace'] . '"');
    }
    $dataItem['klasifikace'] = $klasifikaceMap[$pripad['klasifikace']];
  } else {
    $dataItem['klasifikace'] = '';
  }
  if ($pripad['zdrojSekundarni']) {
    if (!isset($zdrojSekundarniMap[$pripad['zdrojSekundarni']])) {
      throw new Exception('Neznámý sekundární zdroj "' . $pripad['zdrojSekundarni'] . '"');
    }
    $dataItem['zdrojSekundarni'] = $zdrojSekundarniMap[$pripad['zdrojSekundarni']];
  } else {
    $dataItem['zdrojSekundarni'] = '';
  }
  if ($pripad['operacniVykony']) {
    $dataItem['operacniVykony'] = $pripad['operacniVykony'];
  } else {
    $dataItem['operacniVykony'] = '';
  }
  if ($pripad['intervence']) {
    if (!isset($intervenceMap[$pripad['intervence']])) {
      throw new Exception('Neznámá intervence "' . $pripad['intervence'] . '"');
    }
    $dataItem['intervence'] = $intervenceMap[$pripad['intervence']];
  } else {
    $dataItem['intervence'] = '';
  }
  if ($pripad['datumIntervence']) {
    $dataItem['datumIntervence'] = date('Y-m-d', $pripad['datumIntervence']);
  } else {
    $dataItem['datumIntervence'] = '';
  }
  if ($pripad['vznik']) {
    if (!isset($vznikMap[$pripad['vznik']])) {
      throw new Exception('Neznámý vznik "' . $pripad['vznik'] . '"');
    }
    $dataItem['vznik'] = $vznikMap[$pripad['vznik']];
  } else {
    $dataItem['vznik'] = 'Neuve';
  }
  /*/spec*/

  $dataItem['rezistence'] = array_unique($dataItem['rezistence']);
  $dataItem['poznamka'] = trim(implode("\n", $poznamky));
  $dataPardubice[] = $dataItem;
  if ($dataItem['vznik']!='PoPro' && $dataItem['vznik']!='Impor') {
    $data[] = $dataItem;
  }
}

foreach($dataPardubice as $pripad) {
  $sql = 'INSERT INTO lime_survey_139998 SET submitdate=NOW(), lastpage=1, startlanguage="cs"';
  if ($pripad['oddeleni']) { $sql.= ', `139998X195X3436`="'.mysql_real_escape_string($pripad['oddeleni'], $db).'"'; }
  if ($pripad['pracoviste']) { $sql.= ', `139998X195X3437`="'.mysql_real_escape_string($pripad['pracoviste'], $db).'"'; }
  if ($pripad['odbornost']) { $sql.= ', `139998X195X3438`="'.mysql_real_escape_string($pripad['odbornost'], $db).'"'; }
  if ($pripad['typPece']) { $sql.= ', `139998X195X3439`="'.mysql_real_escape_string($pripad['typPece'], $db).'"'; }
  if ($pripad['typInfekceSpec']) { $sql.= ', `139998X195X3440`="'.mysql_real_escape_string($pripad['typInfekceSpec'], $db).'"'; }
  if ($pripad['klasifikace']) { $sql.= ', `139998X195X3441`="'.mysql_real_escape_string($pripad['klasifikace'], $db).'"'; }
  if ($pripad['zdrojSekundarni']) { $sql.= ', `139998X195X3442`="'.mysql_real_escape_string($pripad['zdrojSekundarni'], $db).'"'; }
  if ($pripad['operacniVykony']) { $sql.= ', `139998X195X3443`="'.mysql_real_escape_string($pripad['operacniVykony'], $db).'"'; }
  if ($pripad['intervence']) { $sql.= ', `139998X195X3444`="'.mysql_real_escape_string($pripad['intervence'], $db).'"'; }
  if ($pripad['datumIntervence']) { $sql.= ', `139998X195X3445`="'.mysql_real_escape_string($pripad['datumIntervence'], $db).'"'; }
  if ($pripad['puvodceJiny']) { $sql.= ', `139998X195X3514`="'.mysql_real_escape_string($pripad['puvodceJiny'], $db).'"'; }
  if ($pripad['datumVzniku']) { $sql.= ', `139998X195X3512`="'.mysql_real_escape_string($pripad['datumVzniku'], $db).'"'; }
  if ($pripad['poznamka']) { $sql.= ', `139998X195X3513`="'.mysql_real_escape_string($pripad['poznamka'], $db).'"'; }
  if ($pripad['vznik']) { $sql.= ', `139998X195X3589`="'.mysql_real_escape_string($pripad['vznik'], $db).'"'; }
  
  foreach ($pripad['puvodciSpec'] as $puvodce) {
    $sql.=', 139998X195X3446' . $puvodce['puvodce'] . '_Prit="Y"';
    foreach ($puvodce['rezistence'] as $rez=>$val) {
      $sql.=', 139998X195X3446' . $puvodce['puvodce'] . '_' . $rez . '="'. mysql_real_escape_string($val, $db) . '"';
    }
  }
  mysql_query($sql, $db) or throw new Exception("Could not perform select query - " . mysql_error($db) . "\n" . $sql);
}
